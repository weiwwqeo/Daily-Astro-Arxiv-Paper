name: Daily Galactic Cosmology Paper DigestÂ Â Â Â Â Â Â Â 

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  # push:
  #   branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]
  schedule:
    - cron: '40 23 * * *'


  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      target_date1:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYYMMDDæ ¼å¼)'
        required: false
        default: ''
      target_date2:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYYMMDDæ ¼å¼)'
        required: false
        default: ''

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  RunPaperBot:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    - name: ğŸ“ æ˜¾ç¤ºè¿è¡Œä¿¡æ¯
      id: info
      run: |
        echo "è¿è¡Œæ—¶é—´: $(date)"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "è¿è¡Œåˆ†æ”¯: ${{ github.ref }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "æ‰‹åŠ¨è§¦å‘ï¼Œstart æ—¥æœŸ: ${{ github.event.inputs.target_date1 }}"
          echo "æ‰‹åŠ¨è§¦å‘ï¼Œend æ—¥æœŸ: ${{ github.event.inputs.target_date2 }}"
        fi

    - name: ğŸ“š å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ¤– è¿è¡ŒarXivæœºå™¨äºº
      env:
        ACTIONS_STEP_DEBUG: true
        ACTIONS_RUNNER_DEBUG: true
        # Python æ— ç¼“å†²è¾“å‡º
        PYTHONUNBUFFERED: 1

        # å¿…å¡«Secrets
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        
        # å¯é€‰Secretsï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
        EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER || secrets.EMAIL_SENDER }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        # è¿è¡Œå‚æ•°
        TARGET_DATE1: ${{ github.event.inputs.target_date1 }}
        TARGET_DATE2: ${{ github.event.inputs.target_date2 }}
        
        # æ€§èƒ½è®¾ç½®
        # MAX_PAPERS: ${{ secrets.MAX_PAPERS || '15' }}
        # TEMPERATURE: ${{ secrets.TEMPERATURE || '0.2' }}
        # MAX_TOKENS: ${{ secrets.MAX_TOKENS || '3500' }}
        
        # è¶…æ—¶è®¾ç½®
        LOGIN_TIMEOUT: ${{ secrets.LOGIN_TIMEOUT || '30' }}
        FETCH_TIMEOUT: ${{ secrets.FETCH_TIMEOUT || '90' }}
        AI_TIMEOUT: ${{ secrets.AI_TIMEOUT || '1200' }}
      run: |
        set -x
        echo "å¼€å§‹è¿è¡ŒarXivæœºå™¨äºº..."
        # ä½¿ç”¨å†…ç½®å˜é‡ï¼ˆæ ¼å¼è¾ƒç®€å•ï¼‰
        echo "å½“å‰æ—¶é—´ï¼š$(printf '%(%Y-%m-%d %H:%M:%S)T')"

        echo "ç›®æ ‡æ—¥æœŸ: ${TARGET_DATE1} to ${TARGET_DATE2} "
        echo "AIæ¨¡å‹: ${DEEPSEEK_MODEL}"

        echo "=== è°ƒè¯•ä¿¡æ¯ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Pythonè·¯å¾„: $(which python)"
        echo "Pythonç‰ˆæœ¬:"
        python --version 2>&1
        echo "ç›®å½•å†…å®¹:"
        ls -la

        
        # è¿è¡Œä¸»ç¨‹åº
        python -u ./run_bot.py
        
        echo "=== è¿è¡Œåæ£€æŸ¥ ==="
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
    - name: ğŸ’¾ ä¿å­˜è¿è¡Œæ—¥å¿—
      if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¿å­˜æ—¥å¿—
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-bot-logs-${{ github.run_id }}
        path: |
          *.log
          *.json
          *.html
        retention-days: 7
    
    - name: ğŸ“Š æ£€æŸ¥è¿è¡ŒçŠ¶æ€
      if: always()
      run: |
        echo "è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        fi

